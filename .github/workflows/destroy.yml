name: Destroy Infrastructure

on:
  workflow_dispatch:

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Delete AWS Resources
        run: |
          echo "Cleaning up AWS resources..."
          
          # Delete ECS service first
          echo "Deleting ECS service..."
          aws ecs update-service --cluster hello-fargate --service hello-fargate --desired-count 0 || true
          sleep 30
          aws ecs delete-service --cluster hello-fargate --service hello-fargate || true
          
          # Delete ECS cluster
          echo "Deleting ECS cluster..."
          aws ecs delete-cluster --cluster hello-fargate || true
          
          # Delete ALB and target groups
          echo "Deleting ALB..."
          ALB_ARN=$(aws elbv2 describe-load-balancers --names hello-fargate-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "None")
          if [ "$ALB_ARN" != "None" ]; then
            aws elbv2 delete-load-balancer --load-balancer-arn $ALB_ARN
            echo "Waiting for ALB deletion..."
            sleep 60
          fi
          
          # Delete target group
          echo "Deleting target group..."
          TG_ARN=$(aws elbv2 describe-target-groups --names hello-fargate-tg --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "None")
          if [ "$TG_ARN" != "None" ]; then
            aws elbv2 delete-target-group --target-group-arn $TG_ARN || true
          fi
          
          # Delete ECR repository
          echo "Deleting ECR repository..."
          aws ecr delete-repository --repository-name hello-fargate --force || true
          
          # Delete VPC and associated resources
          echo "Deleting VPC resources..."
          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=hello-fargate-vpc" --query 'Vpcs[0].VpcId' --output text 2>/dev/null || echo "None")
          if [ "$VPC_ID" != "None" ]; then
            # Delete internet gateway
            IGW_ID=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$VPC_ID" --query 'InternetGateways[0].InternetGatewayId' --output text 2>/dev/null || echo "None")
            if [ "$IGW_ID" != "None" ]; then
              aws ec2 detach-internet-gateway --internet-gateway-id $IGW_ID --vpc-id $VPC_ID || true
              aws ec2 delete-internet-gateway --internet-gateway-id $IGW_ID || true
            fi
            
            # Delete subnets
            aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[].SubnetId' --output text | xargs -n1 aws ec2 delete-subnet --subnet-id || true
            
            # Delete security groups (except default)
            aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$VPC_ID" --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text | xargs -n1 aws ec2 delete-security-group --group-id || true
            
            # Delete route tables (except main)
            aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID" --query 'RouteTables[?Associations[0].Main!=`true`].RouteTableId' --output text | xargs -n1 aws ec2 delete-route-table --route-table-id || true
            
            # Finally delete VPC
            aws ec2 delete-vpc --vpc-id $VPC_ID || true
          fi
          
          echo "Cleanup completed!"
