name: ðŸ—‘ï¸ Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      preserve_state:
        description: 'Preserve S3 state bucket and core resources'
        required: false
        default: 'true'
        type: boolean
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: âœ‹ Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Destruction not confirmed. You must type 'DESTROY' to proceed."
            exit 1
          fi
          echo "âœ… Destruction confirmed"

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: ðŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: ðŸ”„ Terraform Init
        working-directory: infra
        run: terraform init

      - name: ðŸ“‹ Show Resources to Destroy
        working-directory: infra
        run: |
          echo "## ðŸ—‘ï¸ Resources to be Destroyed" >> $GITHUB_STEP_SUMMARY
          terraform plan -destroy -no-color | tee destroy_plan.txt
          
          # Extract resource counts
          TO_DESTROY=$(grep -o "Plan: [0-9]* to add, [0-9]* to change, [0-9]* to destroy" destroy_plan.txt | grep -o "[0-9]* to destroy" | grep -o "[0-9]*" || echo "0")
          
          echo "### ðŸ“Š Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ **Resources to Destroy:** $TO_DESTROY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ’° Monthly Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "After destruction, you will save approximately **$150-170/month**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ—ï¸ Resources Being Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- VPC and all networking components" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Fargate cluster and service" >> $GITHUB_STEP_SUMMARY
          echo "- Application Load Balancer" >> $GITHUB_STEP_SUMMARY
          echo "- NAT Gateways and Elastic IPs" >> $GITHUB_STEP_SUMMARY
          echo "- Security Groups and Route Tables" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch Logs and Alarms" >> $GITHUB_STEP_SUMMARY
          echo "- SSL Certificate" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.preserve_state }}" = "false" ]; then
            echo "- âš ï¸ **S3 State Bucket** (will be destroyed)" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ **Secrets Manager Secret** (will be destroyed)" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ **GitHub Actions IAM Role** (will be destroyed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ›¡ï¸ Preserved Resources" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… S3 State Bucket (preserved for future deployments)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Secrets Manager Secret (preserved)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… GitHub Actions IAM Role (preserved)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ECR Repository (preserved)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ—‘ï¸ Destroy Infrastructure
        working-directory: infra
        run: |
          echo "ðŸ—‘ï¸ Starting infrastructure destruction..."
          
          if [ "${{ github.event.inputs.preserve_state }}" = "true" ]; then
            echo "ðŸ›¡ï¸ Preserving core resources for future deployments..."
            # Remove core resources from state temporarily to preserve them
            terraform state rm aws_secretsmanager_secret.db_connection || true
            terraform state rm aws_secretsmanager_secret_version.db_connection || true
            terraform state rm aws_iam_role.github_actions || true
            terraform state rm aws_iam_role_policy_attachment.github_actions_admin || true
          fi
          
          terraform destroy -auto-approve
          echo "## âœ… Destruction Complete" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Additional Cleanup
        if: ${{ github.event.inputs.preserve_state == 'false' }}
        run: |
          echo "ðŸ§¹ Performing additional cleanup..."
          
          # Delete S3 state bucket if not preserving
          echo "Deleting S3 state bucket..."
          aws s3 rm s3://hello-fargate-terraform-state --recursive || true
          aws s3api delete-bucket --bucket hello-fargate-terraform-state || true
          
          # Delete GitHub Actions role if not preserving
          echo "Deleting GitHub Actions role..."
          aws iam detach-role-policy --role-name github-actions-role --policy-arn arn:aws:iam::aws:policy/AdministratorAccess || true
          aws iam delete-role --role-name github-actions-role || true
          
          echo "## ðŸ§¹ Complete Cleanup Finished" >> $GITHUB_STEP_SUMMARY
          echo "All resources including state management have been destroyed." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Cleanup Summary
        run: |
          echo "## ðŸŽ¯ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.preserve_state }}" = "true" ]; then
            echo "âœ… **Infrastructure:** Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ›¡ï¸ **Core Resources:** Preserved for future deployments" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’° **Cost Savings:** ~$150-170/month" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ To Redeploy Later" >> $GITHUB_STEP_SUMMARY
            echo "Simply push to main branch or run the Deploy workflow" >> $GITHUB_STEP_SUMMARY
            echo "No additional setup required!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Everything:** Completely destroyed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’° **Cost Savings:** ~$150-170/month + storage costs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ To Redeploy Later" >> $GITHUB_STEP_SUMMARY
            echo "You'll need to:" >> $GITHUB_STEP_SUMMARY
            echo "1. Recreate S3 state bucket" >> $GITHUB_STEP_SUMMARY
            echo "2. Recreate GitHub Actions IAM role" >> $GITHUB_STEP_SUMMARY
            echo "3. Update GitHub secrets if needed" >> $GITHUB_STEP_SUMMARY
          fi
